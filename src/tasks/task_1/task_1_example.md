## 1. Контекстная диаграмма

Строится по такой модели: https://systems.education/context-diagram#showmore

Она может быть несколько уровней декомпозиции. Допустимо использовать различные дополнительные методики моделирования (IDEF, DFD, UML и т.п.). Важно дать понимания контекста системы, взаимодействующих компонент и ограничений

## 2. CONOPS

### Участники (стейкхолдеры/роли)

1. **Гость** (в зале/на вынос).
2. **Официант** / кассир.
3. **Кухня** (повар/экран KDS).
4. **Менеджер смены**.
5. **Курьер/агрегатор доставки** (если есть).

### Системные элементы (типовая конфигурация)

1. **POS/терминал** (ввод заказа/оплата/чек).
2. **OMS** (Order Management System: управление заказами).
3. **KDS** (Kitchen Display System) или принтер на кухню.
4. **Склад/меню** (наличие, стоп-лист).
5. **Фискализация** (по 54‑ФЗ: ККТ/ОФД — как внешние сервисы/устройства).


### Сценарий 1. Обслуживание в зале: создание заказа и отправка на кухню

### Цель

1. Принять заказ за столом и **передать его на кухню** с корректной привязкой к столу и официанту.

### Условия начала

1. Гость размещён за столом.
2. Официант авторизован в POS/OMS.
3. Меню актуально (цены/наличие).

### Основной поток (Happy path)

1. Официант открывает стол и создаёт новый заказ.
2. Добавляет позиции, модификаторы (прожарка, без лука), комментарии.
3. OMS выполняет проверки: стоп‑лист/ограничения/комбо/аллергены (если ведутся).
4. Официант подтверждает отправку.
5. OMS присваивает **ID заказа**, фиксирует время, автора, стол.
6. OMS отправляет задания на KDS (по цехам: холодный/горячий/бар).
7. Кухня подтверждает прием (явно или по факту отображения/печати).
8. OMS обновляет статус: “В работе”.

### Результат

1. Заказ зарегистрирован и разбит на кухонные задачи, статусы доступны фронту.

### Исключения (нештатные ситуации)

1. **Позиция в стоп‑листе**  
   1.1 OMS блокирует добавление/подтверждение позиции, предлагает альтернативы/замену.
2. **Конфликт модификаторов** (например, “без сыра” + “двойной сыр”)  
   2.1 OMS требует разрешения конфликта до отправки.
3. **Потеря сессии официанта / разлогинило**  
   3.1 OMS сохраняет черновик и требует повторного входа.
4. **KDS/принтер недоступен**  
   4.1 OMS не может доставить задание на кухню, фиксирует ошибку доставки.

### Режимы деградации (как продолжаем работать)

1. **Кухня без KDS (fallback на печать)**  
   1.1 OMS печатает заказ на резервный принтер/в бар.
2. **Полная недоступность кухни по сети**  
   2.1 OMS переводит отправку в очередь, показывает официанту “Не доставлено: ожидает”, разрешает **ручное подтверждение** по телефону/устно и печать “копии” с пометкой “вручную”.
3. **Оффлайн POS при живом локальном OMS**  
   3.1 Разрешить запись заказов локально с последующей синхронизацией.

### Сценарий 2. Разделение счёта, частичная оплата и закрытие стола

### Цель

1. Корректно выполнить **split bill**, принять оплату (карта/нал/СБП) и закрыть заказ без потери позиций.

### Условия начала

1. Заказ имеет статус “Готово/Выдано” или “Можно закрывать”.
2. Кассир/официант имеет право на операции оплаты/разделения.

### Основной поток

1. Официант выбирает заказ и запускает “Разделить счёт”.
2. OMS предлагает варианты: по гостям, по позициям, произвольно.
3. Официант формирует 2+ чека/части заказа.
4. OMS рассчитывает суммы, скидки/бонусы/сервисный сбор, налоги.
5. Принимается оплата по части 1 → фиксируется платёж и фискальный чек.
6. Принимается оплата по части 2 → фиксируется платёж и чек.
7. OMS обновляет статусы: “Оплачено”, закрывает стол.

### Результат

1. Все оплаты зафиксированы, чек(и) сформированы, заказ закрыт.

### Исключения

1. **Платёж отклонён (банк/терминал)**  
   1.1 OMS помечает платёж “Неуспешен”, не закрывает заказ, предлагает повтор/смену метода.
2. **Ошибка фискализации (ККТ/ОФД недоступны)**  
   2.1 OMS запрещает “закрыть” до фискализации или применяет политику “принять оплату с отложенной фискализацией” (зависит от правил ресторана).
3. **Смена цен в процессе** (меню обновилось)  
   3.1 OMS должен зафиксировать цены на момент отправки/подтверждения заказа и не пересчитывать задним числом (или строго по политике).

### Режимы деградации

1. **Нет связи с банком/эквайрингом**  
   1.1 Разрешить приём наличных, СБП по QR “вручную” (если отдельный канал), либо оформить “долг/ожидание оплаты” по правилам ресторана.
2. **ККТ временно недоступна**  
   2.1 OMS ставит фискализацию в очередь, печатает нефискальный слип “оплата принята, чек будет позже” _только если политика разрешает_; иначе блокирует закрытие.
3. **Нет интернета, но локальная сеть работает**  
   3.1 Разрешить закрытие со статусом “Ожидает фискализацию/выгрузку” и последующей отправкой при восстановлении.


#### Таблица “Сценарий → основные сбои → деградация” (для быстрого включения в CONOPS)

|№|Сценарий|Критичный сбой|Деградация (fallback)|
|---|---|---|---|
|1|Зал: отправка на кухню|KDS/принтер недоступен|Очередь доставки + резервная печать/ручное подтверждение|
|2|Split bill и оплата|Эквайринг/ККТ недоступны|Наличные/очередь фискализации/блокировка закрытия по политике|


## 3. Требования

#### 1 - Stakeholder requirements

> Формат: **SR-SH-x** — требования заинтересованных сторон (уровень “что нужно в эксплуатации”, без “как реализовать”).

1. **SR-SH-1 (Официант/кассир — скорость и предсказуемость)**  
   1.1 Система должна позволять сотруднику зала **создавать заказ и передавать его на кухню** так, чтобы сотрудник **видел подтверждение принятия** и актуальный **статус** заказа.

2. **SR-SH-2 (Кухня — корректность и управляемость изменений)**  
   1.1 Система должна обеспечивать кухню **однозначной информацией** по заказу: состав, модификаторы, комментарии, привязка к столу/выносу и время поступления, чтобы минимизировать ошибки приготовления.

3. **SR-SH-3 (Менеджер/бизнес — корректное закрытие и расчёты)**  
   1.1 Система должна поддерживать **разделение счёта и частичные оплаты** с сохранением корректных сумм (позиции, скидки/сборы) и статусов оплаты, чтобы стол/заказ закрывались без финансовых расхождений.

### System requirements

> Формат: **SR-SYS-x** — системные требования (проверяемые, атомарные).


1. **SR-SYS-1 (Сценарий 1: создание/отправка заказа)**  
   1.1 Система должна предоставлять авторизованному пользователю возможность создать заказ с атрибутами: **ID заказа**, **ID стола (если применимо)**, **ID сотрудника**, **временная метка создания**, и минимум одна **позиция меню**.  
   1.2 **Верификация:** инспекция + функциональный тест (создание заказа и проверка полей в БД/логах).

2. **SR-SYS-2 (Сценарий 1: валидация стоп-листа перед отправкой)**  
   1.1 При подтверждении отправки заказа на кухню система должна выполнить проверку доступности позиций по **стоп‑листу** и, если хотя бы одна позиция недоступна, **запретить отправку** до удаления/замены недоступных позиций.  
   1.2 **Верификация:** функциональный тест (позиция “в стоп‑листе” → отправка блокируется).

3. **SR-SYS-3 (Сценарий 1: доставка на кухню и статусы)**  
   1.1 После подтверждения отправки заказа система должна сформировать и передать на кухню кухонные задания (KDS/печать) с данными: **ID заказа**, **перечень позиций**, **модификаторы**, **комментарии**, **тип обслуживания (зал/вынос)** и установить статус заказа **“Отправлен на кухню”**.  
   1.2 **Верификация:** интеграционный тест (проверка факта доставки в KDS/принтер + статуса в OMS).

4. **SR-SYS-4 (Сценарий 2: разделение счёта)**  
   1.1 Система должна позволять разделить заказ минимум на **2 части оплаты** с распределением позиций (или их количеств) по частям и вычислением итогов по каждой части: **сумма позиций**, **скидки/наценки/сервисный сбор (если настроены)**, **итого к оплате**.  
   1.2 **Верификация:** функциональный тест (split → контроль арифметики и состава частей).

5. **SR-SYS-5 (Сценарий 2: закрытие заказа только при полноте оплат)**  
   1.1 Система должна переводить заказ в статус **“Закрыт”** только если суммарно по всем успешным платежам (по всем частям) оплачено **100% итога** заказа; иначе статус заказа должен оставаться **“Ожидает оплату”**.  
   1.2 **Верификация:** функциональный тест (частичная оплата → не закрывается; полная → закрывается).

### NFR / качество с метриками

> Формат: **NFR-x** — нефункциональные требования с измеримыми метриками.


1. **NFR-1 (Производительность/отклик при отправке на кухню — сценарий 1)**  
   1.1 При подтверждении “Отправить на кухню” система должна отображать пользователю результат операции (успех/ошибка) с временем отклика **≤ 2 секунды** в **95‑м перцентиле** при нагрузке **до 10 одновременных активных терминалов POS** в пределах одного ресторана.  
   1.2 **Верификация:** нагрузочное тестирование (замер p95).

2. **NFR-2 (Доступность операции оплаты — сценарий 2)**  
   1.1 Функции “создать платёж” и “зафиксировать результат платежа” должны быть доступны с коэффициентом доступности **≥ 99.5%** в часы работы ресторана, измеряемым как доля времени без отказов за календарный месяц, исключая запланированные окна обслуживания **не более 2 часов/месяц**.  
   1.2 **Верификация:** анализ эксплуатационных метрик/логов (SLA отчёт).


> [!important]  
>  При указании метрик (p95, SLA) - описать общую методику SLA. К примеру, при наличии SLA-отчета, надо расшифровать что вообще входит в понятия SLA для данного проекта

## 4. Архитектура

Тут мы не ограничиваем механики моделирования и не просим сложных архитектур. Могут быть микросервисы / кафки, можеть быть монолит + БД с внешними интеграциями.
Важно учесть все, что выстроено ранее


## 5. Интерфейсы

Прорабатываются для описанной архитектуры, рекомендуется использовать openAPI/protobuf

Важно проработать как внешние интерфейсы (эндпоинты взимодействия), так и внутренние (например: структуры сообщений в кафке)


## 6. Риски
#### Шкала оценки

1. **Вероятность (P):** 1 — низкая, 2 — средняя, 3 — высокая.
2. **Влияние (I):** 1 — низкое, 2 — среднее, 3 — высокое.
3. **Приоритет:** P×I.

Важно описать как составляется шкала

| ID   | Сценарий | Риск (событие)                                                                                                          | Причины                                                                                                                                       | Последствия                                                                                                                      | P   | I   | Приоритет | Меры реагирования (предотвратить/снизить/обнаружить)                                                                                                                                                                                                                                                                                           | Владелец                           | Остаточный риск                                           |
| ---- | -------- | ----------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- | --- | --- | --------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------- | --------------------------------------------------------- |
| R-01 | 1        | **Заказ не доставлен на кухню** (KDS/принтер/канал передачи недоступен), при этом официант считает, что заказ отправлен | 1) Сбой сети Wi‑Fi/LAN 1.1 2) Ошибка KDS/принтера 1.2 3) Необработанные таймауты/нет подтверждения доставки 1.3                               | 1) Задержка приготовления 1.1 2) Потеря заказа/повторный ввод 1.2 3) Негатив гостя, финансовые потери 1.3                        | 2   | 3   | 6         | 1) **Позитивное подтверждение доставки** + явный статус “Доставлено на кухню/В очереди” 1.1 2) Очередь сообщений + ретраи 1.2 3) Резервный канал: печать на другой принтер/ручной тикет 1.3 4) Мониторинг “не доставлено > X мин” и оповещение менеджера 1.4                                                                                   | Техлид/SE + менеджер ресторана     | **Средний** (остается риск физического сбоя оборудования) |
| R-02 | 2        | **Неверные суммы при split bill/частичной оплате** (ошибка распределения скидок/сервисного сбора/налогов)               | 1) Неоднозначные правила распределения скидок 1.1 2) Ошибки округления при делении 1.2 3) Неконсистентность между POS и сервером расчётов 1.3 | 1) Финансовые расхождения, конфликт с гостем 1.1 2) Ошибки бухгалтерии/отчетности 1.2 3) Чеки не сходятся, возвраты 1.3          | 2   | 3   | 6         | 1) Единый модуль расчётов (single source of truth) 1.1 2) Явные правила: **куда распределяется скидка/сбор** и приоритеты 1.2 3) Автотесты на набор “золотых” корзин + property-based проверки округлений 1.3 4) UI‑предпросмотр итогов по частям до подтверждения 1.4                                                                         | Владелец продукта + QA lead        | **Низкий–средний** (останутся редкие крайние кейсы)       |
| R-03 | 2        | **Сбой оплаты/фискализации** приводит к “оплата принята, но заказ не закрыт” или “заказ закрыт без фискального чека”    | 1) Недоступен эквайринг/терминал 1.1 2) Недоступна ККТ/ОФД 1.2 3) Ошибки в обработке статусов платежа/чека 1.3                                | 1) Очереди на кассе, простой 1.1 2) Риски несоответствия правилам фискализации 1.2 3) Потеря денег/двойные списания/возвраты 1.3 | 2   | 3   | 6         | 1) Разделить состояния: “Платёж успешен” ≠ “Чек сформирован” 1.1 2) Политика: **блокировать закрытие** без чека или включать **очередь отложенной фискализации** (строго по регламенту ресторана) 1.2 3) Идемпотентность по payment_id/receipt_id, защита от повторов 1.3 4) Дашборд “зависшие оплаты/чеки” + регламент действий менеджера 1.4 | Финтех/интеграции + менеджер смены | **Средний** (внешние сервисы могут падать)                |


Для каждого риска описать меры реагирования

#### R-01 — Заказ не доставлен на кухню (KDS/принтер/канал недоступен)

##### 1) Предотвращение (Reduce likelihood)

1. **Подтверждение доставки (ACK) от кухни**  
   1.1 OMS переводит заказ в “Доставлено на кухню” только после получения ACK от KDS/print‑service (а не после “отправили запрос”).
2. **Очередь сообщений + повторные попытки**  
   2.1 Все кухонные события кладутся в устойчивую очередь (store‑and‑forward), с ретраями и backoff.
3. **Резервирование оборудования/маршрута**  
   3.1 Дублирующий принтер или резервный KDS‑узел для критичных цехов.
4. **Сетевые меры**  
   4.1 Выделенная VLAN/SSID для POS-KDS, контроль качества Wi‑Fi, UPS для роутера/принтеров (если применимо).

##### 2) Обнаружение (Detect early)

1. **Таймеры доставки**  
   1.1 Если ACK не получен за X секунд → событие “delivery_pending”.
2. **Мониторинг очереди**  
   2.1 Метрика: “кол-во сообщений в очереди кухни”, “возраст самого старого сообщения”, “доля ошибок доставки”.
3. **Алерт менеджеру смены**  
   3.1 Уведомление при “>N заказов в ожидании доставки” или “старейший > Y минут”.

##### 3) Реагирование и восстановление (Respond/Recover)

1. **Автопереключение на резервный канал**  
   1.1 Если KDS недоступен → печать на резервный принтер.
2. **Ручной протокол**  
   2.1 Кнопка “Сформировать аварийный тикет” (печать/экран) + звонок/устное подтверждение кухни.
3. **Повторная отправка**  
   3.1 Кнопка “Повторить отправку” с идемпотентностью (чтобы не создавать дубль на кухне).

##### 4) Fallback / режим деградации (Operate degraded)

1. **Режим “кухня оффлайн”**  
   1.1 OMS принимает заказы, но показывает официанту явный статус “Не доставлено” и запрещает скрывать проблему (нет “зелёной галочки” без ACK).

##### 5) Пост‑инцидент (Improve)

1. **Сверка “пропущенных” заказов**  
   1.1 Список заказов без ACK за период → разбор причин, корректировка порогов и сети.

##### Критерии “готовности” реестра (Definition of Done)

1. У каждого риска есть **владелец** и **триггеры мониторинга** (что считаем инцидентом).
2. Меры включают не только “предотвратить”, но и **обнаружить** и **восстановиться**.
3. Остаточный риск принят/эскалирован менеджером.

## 7. Validation & Verification

#### Обозначения

1. **Метод проверки:** Test (T) / Analysis (A) / Inspection (I) / Demo (D).
2. **Артефакт/кейс:** ссылка на конкретный тест‑кейс, протокол инспекции, отчёт нагрузочного теста, SLA‑отчёт и т.д.

#### Матрица трассируемости

| Requirement ID | Содержание (кратко)                                                                         | Метод проверки | Артефакт/кейс (что именно предъявляем)                                                                                 |
| -------------- | ------------------------------------------------------------------------------------------- | -------------- | ---------------------------------------------------------------------------------------------------------------------- |
| **SR-SH-1**    | Официант может создать заказ, отправить на кухню и видеть подтверждение/статус              | 1) D 2) T      | 1) Демо-сценарий “E2E: стол → кухня” (скрипт демонстрации) 1.1 2) **TC-01** 1.2                                        |
| **SR-SH-2**    | Кухня получает однозначную информацию: позиции, модификаторы, комментарии, стол, время      | 1) I 2) T      | 1) Инспекция шаблона кухонного тикета/экрана KDS (макет/лог) 1.1 2) **TC-01** (проверка содержимого на KDS/печати) 1.2 |
| **SR-SH-3**    | Split bill и частичные оплаты, корректные суммы и статусы                                   | 1) D 2) T      | 1) Демо “Split на 2 части → 2 оплаты → закрытие” (скрипт) 1.1 2) **TC-02** 1.2                                         |
| **SR-SYS-1**   | Создание заказа с обязательными атрибутами (ID, стол, сотрудник, time, позиция)             | 1) I 2) T      | 1) Протокол инспекции полей (скрин/лог/запись в БД) 1.1 2) **TC-01** (шаги создания) 1.2                               |
| **SR-SYS-2**   | При отправке — проверка стоп‑листа; недоступное блокирует отправку                          | 1) T           | **TC-03** “Стоп‑лист блокирует отправку” 1.1                                                                           |
| **SR-SYS-3**   | После отправки формируется и доставляется кухонное задание; статус “Отправлен на кухню”     | 1) T 2) I      | 1) **TC-01** (проверка статуса + факт доставки) 1.1 2) Инспекция сообщения/тикета (ID, позиции, модификаторы) 1.2      |
| **SR-SYS-4**   | Split минимум на 2 части, распределение позиций/количеств и расчёт итогов по частям         | 1) T           | **TC-02** (проверка распределения и итогов) 1.1                                                                        |
| **SR-SYS-5**   | “Закрыт” только при 100% успешной оплаты; иначе “Ожидает оплату”                            | 1) T           | **TC-02** (частичная оплата → не закрыт; полная → закрыт) 1.1                                                          |
| **NFR-1**      | Отклик “Отправить на кухню” ≤ 2 сек p95 при до 10 POS                                       | 1) T 2) A      | 1) Отчёт нагрузочного теста (p95, профиль нагрузки) 1.1 2) Анализ конфигурации стенда/логов замеров 1.2                |
| **NFR-2**      | Доступность функций оплаты/фиксации результата ≥ 99.5% (месяц), окно обслуживания ≤ 2 ч/мес | 1) A 2) I      | 1) SLA/SLO отчёт по метрикам доступности (аптайм) 1.1 2) Инспекция журналов инцидентов и окон обслуживания 1.2         |

#### TC-01 — E2E: создание заказа и доставка на кухню (с проверкой содержимого и статуса)

### Цель

1. Подтвердить выполнение **SR-SYS-1**, **SR-SYS-3** и частично **SR-SH-1/SR-SH-2**: заказ создаётся, получает атрибуты, уходит на кухню, статусы корректны, кухня видит нужные поля.

### Предусловия

1. Пользователь “Официант1” активен и авторизован в POS/OMS.
2. Стол **T-07** существует и доступен.
3. KDS (или кухонный принтер) включён и доступен.
4. Блюдо “Бургер” доступно (не в стоп‑листе).

### Данные

1. Позиция: “Бургер”
2. Модификатор: “Прожарка: medium”
3. Комментарий: “Без лука”

### Шаги

1. Открыть стол **T-07** в POS/OMS.
2. Создать новый заказ.
3. Добавить позицию “Бургер”.
4. Указать модификатор “Прожарка: medium”.
5. Добавить комментарий “Без лука”.
6. Нажать “Отправить на кухню”.
7. Зафиксировать на фронте: отображаемый **ID заказа** и **статус**.
8. На KDS/печати найти соответствующий заказ по **ID**.

### Ожидаемые результаты

1. Заказ создан и имеет атрибуты: **ID заказа**, **ID стола=T-07**, **ID сотрудника=Официант1**, **время создания**, **≥1 позиция**.
2. После шага 6 статус заказа становится **“Отправлен на кухню”** (или эквивалент, согласованный в модели статусов).
3. На KDS/печати отображаются: **ID заказа**, “Бургер”, “Прожарка: medium”, “Без лука”, **стол T-07**, **время/порядок поступления** (если предусмотрено).
4. Нет дублей: на кухне появляется **одна** запись/тикет для данного заказа.

### Постусловия

1. Заказ находится в статусе “Отправлен на кухню/В работе” (в зависимости от жизненного цикла статусов).

---

#### TC-02 — Split bill на 2 части + частичная оплата + закрытие при 100% оплате

### Цель

1. Подтвердить **SR-SYS-4** и **SR-SYS-5** (и поддержать **SR-SH-3**): корректное разделение, корректные суммы, закрытие только при полной оплате.

### Предусловия

1. Существует открытый заказ **Z** на стол **T-07** с 2 позициями:  
   1.1 “Паста” = 600 ₽  
   1.2 “Сок” = 200 ₽
2. Скидки/сборы отключены (для базовой проверки арифметики) _или_ заданы и документированы (если хотите тестировать их).
3. Пользователь имеет права на split и оплату.
4. Платёжный метод доступен (тестовый эквайринг/наличные).

### Шаги

1. Открыть заказ **Z** и выбрать “Разделить счёт”.
2. Создать **2 части**:  
   2.1 Часть A: “Паста” (600 ₽)  
   2.2 Часть B: “Сок” (200 ₽)
3. Подтвердить split и проверить итоги по частям.
4. Выполнить оплату **только части A** (600 ₽) успешным платежом.
5. Проверить статус заказа и части B.
6. Выполнить оплату части B (200 ₽) успешным платежом.
7. Проверить финальный статус заказа.

### Ожидаемые результаты

1. После шага 2 система имеет **минимум 2 части оплаты** и позиции распределены строго по выбранным частям.
2. Итоги: Часть A = 600 ₽, Часть B = 200 ₽, сумма частей = 800 ₽.
3. После шага 4:  
   3.1 Часть A имеет статус “Оплачено” и успешный платеж.  
   3.2 Заказ **не** переходит в “Закрыт”; остаётся “Ожидает оплату” (или эквивалент).
4. После шага 6–7:  
   4.1 Часть B “Оплачено”.  
   4.2 Заказ переходит в статус **“Закрыт”**.

### Постусловия

1. В истории заказа видны 2 платежа, привязанные к соответствующим частям.

---

#### TC-03 — Стоп‑лист блокирует отправку на кухню (негативный тест)

### Цель

1. Подтвердить **SR-SYS-2**: недоступная позиция не должна быть отправлена на кухню.

### Предусловия

1. Позиция “Стейк” добавлена в **стоп‑лист**.
2. Официант авторизован, стол доступен, кухня доступна (неважно, т.к. отправки быть не должно).

### Шаги

1. Создать заказ на стол **T-03**.
2. Добавить позицию “Стейк”.
3. Нажать “Отправить на кухню”.

### Ожидаемые результаты

1. Система **блокирует отправку**.
2. Пользователь видит сообщение: “Позиция недоступна (стоп‑лист)” (текст может отличаться, смысл обязателен).
3. Заказ **не** получает статус “Отправлен на кухню” и **не появляется** на KDS/печати.
